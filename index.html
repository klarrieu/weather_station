<head> 
	<meta charset="UTF-8">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<title>⛅  Speckled Weather Station</title>
<link rel='icon' type='image/jpg', href=''>
<body>


<h2>⛅  Welcome to the Speckled Weather Station! ⛅</h2>
<h2>Current Conditions:</h2>
<button id="button">Change Units</button>
<h3 id="air_temps_text"></h3>
<h3 id="air_pressures_text"></h3>
<h3 id="humidities_text"></h3>
<h3 id="aqis_text"></h3>
<h3 id="pm2_5s_text"></h3>
<h3 id="pm10s_text"></h3>
<p id="ts_text" style="color:#808080; font-size:14"></p>

<script>
var temp_unit = "C";

function c_to_f(temp){
  return +(9/5 * temp + 32).toFixed(2);
};

function change_units(){
  if (temp_unit == "C"){temp_unit = "F"}
  else{temp_unit = "C"};
  write_text();
  init_plots();
};

var button = document.getElementById("button");
button.addEventListener("click", function(){change_units();});
</script>

<script>
const pars = [
  'air_temps',
  'air_pressures',
  'humidities',
  'aqis',
  'pm2_5s',
  'pm10s'
];

function parse_update(){
  weather_data.tss = weather_data.tss.concat(weather_update.ts);
  weather_data.air_temps = weather_data.air_temps.concat(weather_update.air_temp);
  weather_data.air_pressures = weather_data.air_pressures.concat(weather_update.air_pressure);
  weather_data.humidities = weather_data.humidities.concat(weather_update.humidity);
  weather_data.aqis = weather_data.aqis.concat(weather_update.aqi);
  weather_data.pm2_5s = weather_data.pm2_5s.concat(weather_update.pm2_5);
  weather_data.pm10s = weather_data.pm10s.concat(weather_update.pm10);
};

function write_text(){
  const par_names = {
    'air_temps': '🌡️T',
    'air_pressures': '🌪️p',
    'humidities': '🌫️RH',
    'aqis': '💨AQI',
    'pm2_5s': '💨PM<sub>2.5</sub>',
    'pm10s': '💨PM<sub>10</sub>'
  };
  var par_units = {
    'air_temps': ` °${temp_unit}`,
    'air_pressures': ' hPa',
    'humidities': '%',
    'aqis': '',
    'pm2_5s': ' μg/m<sup>3</sup>',
    'pm10s': ' μg/m<sup>3</sup>'
  };

  for (let par of pars){
    var current_val = weather_data[par].slice(-1)[0];
    if (par == 'air_temps' & temp_unit == "F"){current_val = c_to_f(current_val)};
    document.getElementById(`${par}_text`).innerHTML = `${par_names[par]}: ${current_val}${par_units[par]}`;
  };
  var current_ts = weather_data.tss.slice(-1)[0];
  document.getElementById("ts_text").innerHTML = `Last updated: ${current_ts}`;
};
</script>

<div id="air_temps_graph"></div>
<div id="air_pressures_graph"></div>
<div id="humidities_graph"></div>
<div id="aqis_graph"></div>
<div id="pm2_5s_graph"></div>
<div id="pm10s_graph"></div>

<script>
function movingAverage(array, window){
  if (array.length < window){
    return [];
  }
  let i = window;
  const ma = [];
      while (++i < array.length + 1){
        const aslice = array.slice(i - window, i);
        const sum = aslice.reduce((prev, curr) => prev + curr, 0);
        ma.push(+ (sum / window).toFixed(2));
      }
return ma;
}

function weather_ma(par, window=15){
  tss_ma = weather_data.tss.slice(window)
  par_ma = movingAverage(weather_data[par], window=window);
  if (par == 'air_temps' & temp_unit == "F") {par_ma = par_ma.map(t => c_to_f(t))};
  return {x: tss_ma,
          y: par_ma,
          name: `${window}-min MA`,
          line: {shape: 'spline'}
         };
}

function init_plots(){
  var plot_titles = {
    'air_temps': `Air Temperature [°${temp_unit}]`,
    'air_pressures': 'Air Pressure [hPa]',
    'humidities': 'Relative Humidity [%]',
    'aqis': 'Air Quality Index',
    'pm2_5s': 'PM<sub>2.5</sub> [μg/m<sup>3</sup>]',
    'pm10s': 'PM<sub>10</sub> [μg/m<sup>3</sup>]'
  };
  var config = {responsive: true};

  for (let par of pars){
  var layout = {title: plot_titles[par]};
  var y = weather_data[par];
  if (par == 'air_temps' & temp_unit == "F") {y = y.map(t => c_to_f(t))};
  Plotly.newPlot(`${par}_graph`, [{
    x: weather_data.tss,
    y: y,
    mode: 'lines',
    name: 'real time',
    line: {color: '#80CAF6',
           shape: 'spline'}
    }, weather_ma(par)],
    layout, config
  );
  };
}
</script>

<script>
function update_plots(){
  for (let par of pars){
    var current_ts = weather_data.tss.slice(-1)[0];
    var current_val = weather_data[par].slice(-1)[0];
    var current_ma = weather_ma(par)['y'].slice(-1)[0];
    if (par == 'air_temps' & temp_unit == "F"){current_val = c_to_f(current_val)};
    var plot_update = {
      x: [[current_ts], [current_ts]],
      y: [[current_val], [current_ma]]
    };
    Plotly.extendTraces(`${par}_graph`, plot_update, [0, 1]);
  };
};
</script>


<script src="/socket.io/socket.io.js"></script>
<script>
var weather_data = {};
var weather_update = {};
var socket = io.connect('/');
socket.on('announcements', function(data) {
    console.log('Got announcement:', data.message);
});
socket.on('data', function(data) {
    console.log('Got data:', data.tss);
    weather_data = data;
    write_text();
    init_plots();
});
socket.on('update', function(update){
  console.log('Got update:', update.update);
  weather_update = update.update;
  parse_update();
  write_text();
  update_plots();
});
</script>
